<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <title>Enabling and disabling USB Disk Drive using C# - DevJammer</title>
  <meta name="description" content="">

  <link rel="shortcut icon" type="image/png" href="/devjammer/favicon.png" >
  <link rel="stylesheet" href="/devjammer/css/main.css">
  <link rel="canonical" href="http://localhost:4000/devjammer/enable-disable-driver-csharp">
</head>

  <body>
    <aside id="announcement">
  <div id="ribbon">
    <a href="https://thedarkprojects.github.io/" target="_blank"><h1>The Dark Projects</h1></a>
    <div>DevJammer: see overview of all my open source projects at <a href="https://thecarisma.github.io/" target="_blank">thecarisma.github.io</a>, <a href="https://libsuperc.github.io/" target="_blank">libsuperc</a>, or <a href="https://twitter.com/iamthecarisma" target="_blank">Twitter</a></div>
  </div>
</aside>

    <header>
  <div class="site-title"><a href="/devjammer/">DevJammer</a></div>
  <nav>
    
    
      <div class="category">Main Menu</div>
      <ul>
      
	  
      
        <li><a href="/devjammer/download">Download</a></li>
      
        <li><a href="/devjammer/documentation">Documentation</a></li>
      
        <li><a href="/devjammer/screenshots">Screenshots</a></li>
      
        <li><a href="/devjammer/contribute">Contribute</a></li>
      
        <li><a href="/devjammer/support">Support</a></li>
      
      </ul>
    
      <div class="category">Blog</div>
      <ul>
      
	  
      
        <li><a href="/devjammer/enable-disable-driver-csharp">Enabling and disabling USB Disk Drive using C#</a></li>
      
      </ul>
    
    
      <div class="category"><a href="/devjammer/">What is DevJammer</a></div>
    
      <div class="category"><a href="/devjammer/css/main.css"></a></div>
    
      <div class="category"><a href="/devjammer/assets/css/style.css"></a></div>
    
	
	<div class="category">Extenal</div>
	  <ul>
	    
	      <li><a href="https://thecarisma.github.io/Cronux/">Cronux</a></li>
	    
	      <li><a href="http://www.jrsoftware.org/isinfo.php">Inno Setup</a></li>
	    
	  </ul>
	</div>
	
	<div class="category">Social</div>
	  <ul>
	    
	      <li><a href="https://www.twitter.com/iamthecarisma">Twitter</a></li>
	    
	      <li><a href="https://github.com/thedarkprojects/devjammer">Github</a></li>
	    
	  </ul>
	</div>
  </nav>
</header>

    <div class="page-content">
        <article>
    <div class="title">Enabling and disabling USB Disk Drive using C#</div>
    <p><img src="./images/enable-disable-driver-csharp/head.png" alt="head.png" /></p>

<p>Working with device drivers from a managed environment like .NET can be messy and sometimes not possible without making a call to unmanaged native code APIs. In this post, I will show how to enable and disable USB disk drive in C# using ManagementObjectSearcher and Native setupapi.</p>

<p>Before a device can be enabled or disable we need to know the device GUID and its instance path.</p>

<h2 id="getting-device-guid-and-instance-path">Getting device GUID and instance path</h2>

<p>GUID(Globally Unique Identifier) is also known as UUID(Universally Unique Identifier) is a 128-bit integer number used to identify resources. Every device has hard-coded GUID but to get the GUID from C# we can query the device group using <a href="https://docs.microsoft.com/en-us/dotnet/api/system.management.managementobjectsearcher">ManagementObjectSearcher</a>. To use the ManagementObjectSearcher class you will need to add the  <code class="highlighter-rouge">System.Management</code> reference to the project.</p>

<p>In our case we need to get the detail of disk drive hence we will query one of the Win32 class <a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/cim-diskdrive"><code class="highlighter-rouge">DiskDrive</code></a>, <a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/cim-logicaldevice"><code class="highlighter-rouge">CIM_LogicalDevice</code></a> or <a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/cim-logicalelement"><code class="highlighter-rouge">CIM_LogicalElement</code></a>. Querying DiskDrive will only give information on currently enabled Disk Drive but we need to get all drives on the system including those with error, disabled, mounted e.t.c. hence we use the CIM_LogicalDevice class which is the supertype of the DiskDrive class.</p>

<p>Add the following namespaces in your code.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Collections.Generic</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Management</span><span class="p">;</span>
</code></pre></div></div>

<p>Create the static method to get all known logical drive from the system</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ManagementBaseObject</span><span class="p">&gt;</span> <span class="nf">GetLogicalDevices</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">List</span><span class="p">&lt;</span><span class="n">ManagementBaseObject</span><span class="p">&gt;</span> <span class="n">devices</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">ManagementBaseObject</span><span class="p">&gt;();</span>
    <span class="n">ManagementObjectCollection</span> <span class="n">collection</span><span class="p">;</span>
    <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">searcher</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ManagementObjectSearcher</span><span class="p">(</span><span class="s">"root\\CIMV2"</span><span class="p">,</span> 
                          <span class="s">@"Select * From CIM_LogicalDevice"</span><span class="p">))</span>
                          <span class="n">collection</span> <span class="p">=</span> <span class="n">searcher</span><span class="p">.</span><span class="nf">Get</span><span class="p">();</span>
    <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">device</span> <span class="k">in</span> <span class="n">collection</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">devices</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">collection</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">devices</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Note the class we choose to query in the line <code class="highlighter-rouge">@"Select * From CIM_LogicalDevice"))</code> you can change from <code class="highlighter-rouge">CIM_LogicalDevice</code> to other device class you wish to get in case you want to fetch detail of other kind of devices e.g to get all known keyboard you can change it to <code class="highlighter-rouge">CIM_Keyboard</code>, <code class="highlighter-rouge">@"Select * From CIM_Keyboard"))</code>. You can see all the list of device classes at https://docs.microsoft.com/en-gb/windows/win32/cimwin32prov/cim-wmi-provider.</p>

<h4 id="iterating-over-our-devices-to-get-guids-and-instance-paths">Iterating over our devices to get GUIDs and instance paths</h4>

<p>To get the properties of the returned devices we need to use the <code class="highlighter-rouge">GetPropertyValue</code> method of <a href="https://docs.microsoft.com/en-us/dotnet/api/system.management.managementbaseobject">ManagementBaseObject</a> to extract the value of a property of the device. The device classes have different properties hence the doc should be consulted before trying to get property value from a ManagementBaseObject. In our case, we need the properties of <a href="https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/cim-logicaldevice"><code class="highlighter-rouge">CIM_LogicalDevice</code></a> specifically <strong>DeviceID</strong> which holds the instance path and <strong>ClassGuid</strong> which holds the GUID.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">usbDevices</span> <span class="p">=</span> <span class="nf">GetLogicalDevices</span><span class="p">();</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">usbDevice</span> <span class="k">in</span> <span class="n">usbDevices</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="s">"Name: {0}, Status: {1}, Instance Path: {2}, GUID: {3}"</span><span class="p">,</span>
                       <span class="n">usbDevice</span><span class="p">.</span><span class="nf">GetPropertyValue</span><span class="p">(</span><span class="s">"Caption"</span><span class="p">),</span>
                       <span class="n">usbDevice</span><span class="p">.</span><span class="nf">GetPropertyValue</span><span class="p">(</span><span class="s">"Status"</span><span class="p">),</span>
                       <span class="n">usbDevice</span><span class="p">.</span><span class="nf">GetPropertyValue</span><span class="p">(</span><span class="s">"DeviceID"</span><span class="p">),</span>
                       <span class="n">usbDevice</span><span class="p">.</span><span class="nf">GetPropertyValue</span><span class="p">(</span><span class="s">"ClassGuid"</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="disabling-and-enabling-the-drive-using-it-guid-and-instance-path">Disabling and Enabling the drive using it GUID and Instance path</h2>

<p>After getting the GUID and Instance path of the device to be enabled or disabled we can make a call to the Win32 unmanaged <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/install/setupapi">SetupAPI</a> to interact with the device drivers.</p>

<p>The following native setup API methods are required to enable and disable a device:</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">SetupDiEnumDeviceInfo</span><span class="p">(</span><span class="n">SafeDeviceInfoSetHandle</span> <span class="n">deviceInfoSet</span><span class="p">,</span> <span class="kt">int</span> <span class="n">memberIndex</span><span class="p">,</span> <span class="k">ref</span> <span class="n">DeviceInfoData</span> <span class="n">deviceInfoData</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">SetupDiCallClassInstaller</span><span class="p">(</span><span class="n">DiFunction</span> <span class="n">installFunction</span><span class="p">,</span> <span class="n">SafeDeviceInfoSetHandle</span> <span class="n">deviceInfoSet</span><span class="p">,</span> <span class="p">[</span><span class="nf">In</span><span class="p">()]</span> <span class="k">ref</span> <span class="n">DeviceInfoData</span> <span class="n">deviceInfoData</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="n">SafeDeviceInfoSetHandle</span> <span class="nf">SetupDiGetClassDevs</span><span class="p">([</span><span class="nf">In</span><span class="p">()]</span> <span class="k">ref</span> <span class="n">Guid</span> <span class="n">classGuid</span><span class="p">,</span> <span class="p">[</span><span class="nf">MarshalAs</span><span class="p">(</span><span class="n">UnmanagedType</span><span class="p">.</span><span class="n">LPWStr</span><span class="p">)]</span> <span class="kt">string</span> <span class="n">enumerator</span><span class="p">,</span> <span class="n">IntPtr</span> <span class="n">hwndParent</span><span class="p">,</span> <span class="n">SetupDiGetClassDevsFlags</span> <span class="n">flags</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">SetupDiGetDeviceInstanceId</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">DeviceInfoSet</span><span class="p">,</span> <span class="k">ref</span> <span class="n">DeviceInfoData</span> <span class="n">did</span><span class="p">,</span> <span class="p">[</span><span class="nf">MarshalAs</span><span class="p">(</span><span class="n">UnmanagedType</span><span class="p">.</span><span class="n">LPTStr</span><span class="p">)]</span> <span class="n">StringBuilder</span> <span class="n">DeviceInstanceId</span><span class="p">,</span> <span class="kt">int</span> <span class="n">DeviceInstanceIdSize</span><span class="p">,</span> <span class="k">out</span> <span class="kt">int</span> <span class="n">RequiredSize</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">SetupDiDestroyDeviceInfoList</span><span class="p">(</span><span class="n">IntPtr</span> <span class="n">deviceInfoSet</span><span class="p">);</span>
<span class="k">public</span> <span class="k">static</span> <span class="k">extern</span> <span class="kt">bool</span> <span class="nf">SetupDiSetClassInstallParams</span><span class="p">(</span><span class="n">SafeDeviceInfoSetHandle</span> <span class="n">deviceInfoSet</span><span class="p">,</span> <span class="p">[</span><span class="nf">In</span><span class="p">()]</span> <span class="k">ref</span> <span class="n">DeviceInfoData</span> <span class="n">deviceInfoData</span><span class="p">,</span> <span class="p">[</span><span class="nf">In</span><span class="p">()]</span> <span class="k">ref</span> <span class="n">PropertyChangeParameters</span> <span class="n">classInstallParams</span><span class="p">,</span> <span class="kt">int</span> <span class="n">classInstallParamsSize</span><span class="p">);</span>

</code></pre></div></div>

<p>To enable/disable a device the GUID is used to fetch <a href="http://www.ltr-data.se/library/ArsenalImageMounter/html/86d140b9-91dd-7f87-e44f-67d17bcdf590.htm"><code class="highlighter-rouge">SafeDeviceInfoSetHandle</code></a> of the device from the <code class="highlighter-rouge">SetupDiGetClassDevs</code> native method.</p>

<p>Since the GUID is for a group of devices i.e more than one device will have the GUID so far the devices fall under the same device class. The native method <code class="highlighter-rouge">GetDeviceInfoData</code> is used to get all the devices under the GUID.</p>

<p>The instance id will determine the actual device we want to change its state, the <code class="highlighter-rouge">GetIndexOfInstance</code> is invoked with diSetHandle,  the array of GetDeviceInfoData and the instance ID to get the index of the device in the list of all the devices returned by the GetDeviceInfoData method.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">SetDeviceEnabled</span><span class="p">(</span><span class="n">Guid</span> <span class="n">classGuid</span><span class="p">,</span> <span class="kt">string</span> <span class="n">instanceId</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">SafeDeviceInfoSetHandle</span> <span class="n">diSetHandle</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">diSetHandle</span> <span class="p">=</span> <span class="n">NativeMethods</span><span class="p">.</span><span class="nf">SetupDiGetClassDevs</span><span class="p">(</span><span class="k">ref</span> <span class="n">classGuid</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> 
                      <span class="n">IntPtr</span><span class="p">.</span><span class="n">Zero</span><span class="p">,</span> <span class="n">SetupDiGetClassDevsFlags</span><span class="p">.</span><span class="n">Present</span><span class="p">);</span>
        <span class="n">DeviceInfoData</span><span class="p">[]</span> <span class="n">diData</span> <span class="p">=</span> <span class="nf">GetDeviceInfoData</span><span class="p">(</span><span class="n">diSetHandle</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">index</span> <span class="p">=</span> <span class="nf">GetIndexOfInstance</span><span class="p">(</span><span class="n">diSetHandle</span><span class="p">,</span> <span class="n">diData</span><span class="p">,</span> <span class="n">instanceId</span><span class="p">);</span>
        <span class="nf">EnableDevice</span><span class="p">(</span><span class="n">diSetHandle</span><span class="p">,</span> <span class="n">diData</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">enable</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">finally</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">diSetHandle</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">diSetHandle</span><span class="p">.</span><span class="n">IsClosed</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span>
            <span class="p">{</span>
               <span class="n">diSetHandle</span><span class="p">.</span><span class="nf">Close</span><span class="p">();</span>
           <span class="p">}</span>
           <span class="n">diSetHandle</span><span class="p">.</span><span class="nf">Dispose</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The SafeDeviceInfoSetHandle, the array of DeviceInfoData and the condition(true/false) is sent into our EnableDevice method to change the device state. The EnableDevice method is implemented below. We make a call on the native method in setupdi <code class="highlighter-rouge">SetupDiSetClassInstallParams</code> to change the state of the device</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">EnableDevice</span><span class="p">(</span><span class="n">SafeDeviceInfoSetHandle</span> <span class="n">handle</span><span class="p">,</span> 
                                 <span class="n">DeviceInfoData</span> <span class="n">diData</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">PropertyChangeParameters</span> <span class="n">@params</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">PropertyChangeParameters</span><span class="p">();</span>
    <span class="n">@params</span><span class="p">.</span><span class="n">Size</span> <span class="p">=</span> <span class="m">8</span><span class="p">;</span>
    <span class="n">@params</span><span class="p">.</span><span class="n">DiFunction</span> <span class="p">=</span> <span class="n">DiFunction</span><span class="p">.</span><span class="n">PropertyChange</span><span class="p">;</span>
    <span class="n">@params</span><span class="p">.</span><span class="n">Scope</span> <span class="p">=</span> <span class="n">Scopes</span><span class="p">.</span><span class="n">Global</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">@params</span><span class="p">.</span><span class="n">StateChange</span> <span class="p">=</span> <span class="n">StateChangeAction</span><span class="p">.</span><span class="n">Enable</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
        <span class="n">@params</span><span class="p">.</span><span class="n">StateChange</span> <span class="p">=</span> <span class="n">StateChangeAction</span><span class="p">.</span><span class="n">Disable</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">bool</span> <span class="n">result</span> <span class="p">=</span> <span class="n">NativeMethods</span><span class="p">.</span><span class="nf">SetupDiSetClassInstallParams</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">diData</span><span class="p">,</span> 
                                           <span class="k">ref</span> <span class="n">@params</span><span class="p">,</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">SizeOf</span><span class="p">(</span><span class="n">@params</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nf">Win32Exception</span><span class="p">();</span>
    <span class="n">result</span> <span class="p">=</span> <span class="n">NativeMethods</span><span class="p">.</span><span class="nf">SetupDiCallClassInstaller</span><span class="p">(</span><span class="n">DiFunction</span><span class="p">.</span><span class="n">PropertyChange</span><span class="p">,</span>
                                                     <span class="n">handle</span><span class="p">,</span> <span class="k">ref</span> <span class="n">diData</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="p">==</span> <span class="k">false</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span> <span class="p">=</span> <span class="n">Marshal</span><span class="p">.</span><span class="nf">GetLastWin32Error</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="p">==</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">SetupApiError</span><span class="p">.</span><span class="n">NotDisableable</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">ArgumentException</span><span class="p">(</span><span class="s">"Device can't be disabled (programmatically)."</span><span class="p">);</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="p">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">SetupApiError</span><span class="p">.</span><span class="n">NoAssociatedClass</span> <span class="p">&amp;&amp;</span> 
                <span class="n">err</span> <span class="p">&lt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">SetupApiError</span><span class="p">.</span><span class="n">OnlyValidateViaAuthenticode</span><span class="p">)</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Win32Exception</span><span class="p">(</span><span class="s">"SetupAPI error: "</span> <span class="p">+</span> <span class="p">((</span><span class="n">SetupApiError</span><span class="p">)</span><span class="n">err</span><span class="p">).</span><span class="nf">ToString</span><span class="p">());</span>
        <span class="k">else</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">Win32Exception</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <a href="https://docs.microsoft.com/en-us/windows/win32/api/setupapi/"><code class="highlighter-rouge">SETUPAPI</code></a> native method full source code is at https://github.com/thedarkprojects/devjammer/blob/master/NativeSetupDiLib.cs the file can be placed in your project without the need for extra dependency.</p>

<p>The <code class="highlighter-rouge">EnableDevice</code> method can be called with the GUID and Instance id gotten from <code class="highlighter-rouge">ManagementObjectSearcher</code> query above and our boolean to enable or disable the drive. E.g. to disable an already active disk drive connect with USB (external hard disk, card reader, MTP Device), we can check the list of Logical Drive and disable the drive that contains USB and is enabled</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">usbDevices</span> <span class="p">=</span> <span class="nf">GetLogicalDevices</span><span class="p">();</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">usbDevice</span> <span class="k">in</span> <span class="n">usbDevices</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">usbDevice</span><span class="p">.</span><span class="nf">GetPropertyValue</span><span class="p">(</span><span class="s">"DeviceID"</span><span class="p">).</span><span class="nf">ToString</span><span class="p">().</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"USB"</span><span class="p">)</span> <span class="p">&amp;&amp;</span> 
        <span class="n">usbDevice</span><span class="p">.</span><span class="nf">GetPropertyValue</span><span class="p">(</span><span class="s">"Status"</span><span class="p">).</span><span class="nf">ToString</span><span class="p">().</span><span class="nf">Contains</span><span class="p">(</span><span class="s">"OK"</span><span class="p">)</span> <span class="p">)</span> 
    <span class="p">{</span>
        <span class="n">Guid</span> <span class="n">mouseGuid</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Guid</span><span class="p">(</span><span class="n">usbDevice</span><span class="p">.</span><span class="nf">GetPropertyValue</span><span class="p">(</span><span class="s">"ClassGuid"</span><span class="p">).</span><span class="nf">ToString</span><span class="p">());</span>
        <span class="kt">string</span> <span class="n">instancePath</span> <span class="p">=</span> <span class="n">usbDevice</span><span class="p">.</span><span class="nf">GetPropertyValue</span><span class="p">(</span><span class="s">"DeviceID"</span><span class="p">).</span><span class="nf">ToString</span><span class="p">();</span>
        <span class="n">DeviceHelper</span><span class="p">.</span><span class="nf">SetDeviceEnabled</span><span class="p">(</span><span class="n">mouseGuid</span><span class="p">,</span> <span class="n">instancePath</span><span class="p">,</span> <span class="k">true</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If the state of the device does not change en exception is thrown. If no exception occurs in the method the state of the device has changed successfully.</p>

<p>When building the project ensure CPU target corresponds to the CPU architecture of your system as the SETUPAPI is conscious of CPU architecture. The functionalities will not work on an x86 system if the build target is x64 and it won’t work on x64 if the target build is x86. If you are using a 64bit system ensure your CPU target build is x64 and if your system is 32bit ensure your build target is x86. Also, you have to run the app in Administrator Mode for it to work.</p>

<h2 id="applications">Applications</h2>

<p>The <code class="highlighter-rouge">ManagementObjectSearcher</code> query can be used to get pretty much any or all types of devices on the Windows system. With a careful combination of the ManagementObjectSearcher queries and the <a href="https://github.com/thedarkprojects/devjammer/blob/master/NativeSetupDiLib.cs">NativeSetupDiLib</a> you can implement a custom Device control application that can block access to system e.g blocking the USB port by listening for device changes and if not allowed in your application you immediately disable the device connected in the USB port. It can also be used to bypass device control by anti-virus programs by continual enabling of a device if the dev control program disable it (be careful).</p>

<p>If you are choosing to perform the device enabling and disabling from command line by writing a system script (batch/powershell) you can check out the <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/devcon"><code class="highlighter-rouge">devcon tool</code></a> provided by Microsoft which also uses the <a href="https://docs.microsoft.com/en-us/windows/win32/api/setupapi/"><code class="highlighter-rouge">SETUP APIs</code></a>. For the devcon program to work ensure you download the CPU architecture version for your system e.g. <strong>devcon-x64</strong> if your PC is 64bit.</p>

<hr />
<ul>

</ul>

</article>

    </div>
    <footer class="site-footer">

  <div class="year">2019–present&emsp;Filed under csharp, cpp, windows, devmgmt</div>
  <a class="overview" href="/devjammer/">back to overview</a>


<div class="social-media">
  
	<a class="" href="https://www.twitter.com/iamthecarisma">Twitter</a>
  
	<a class="" href="https://github.com/thedarkprojects/devjammer">Github</a>
  
  <br /> <a href="https://thedarkprojects.github.io/">This program is part of the dark projects</a> 
</div>
</ul>
</footer>

  </body>
</html>
